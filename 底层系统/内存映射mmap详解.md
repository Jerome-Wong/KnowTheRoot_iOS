# 内存映射mmap详解
  
### 什么是内存映射？
所谓内存映射，就是**将文件的磁盘扇区映射到进程的虚拟内存空间**的过程。

### 操作系统中的进程 
- 进程就是一个正在运行的应用程序
- 每一个进程都是独立的，并且每一个进程都在一个独立的、受保护的空间内
- 在Linux系统中，通常使用fork()方法来开启一个新的进程
- 在iOS系统中，每一个进程都有自己的内存和磁盘空间，其他的进程是不被允许访问的

## 操作系统读写文件流程

### 读写操作的流程

1.进程发起一个读文件请求;  

2.内核通过查找**进程文件符表**，定位到内核已打开的文件集上的文件信息，从而找到对应文件的inode;  

3.inode在地址空间（address_space）上查找要请求的文件**是否已经缓存在内核页的高速缓存中**，如果存在，则直接放回该文件的内容;  

4.如果文件不存在高速缓存中，则通过inode定位到文件的磁盘地址，**将数据从磁盘复制到内核页高速缓存。之后再次范圣琦读页面的过程，将内核高速缓存中的数据发送给用户进程**；

> ### 什么是inode?
>
>全称为index node，既**存储文件元信息的区域**，中文译名“索引节点”。  
>例如包含：文件权限、文件拥有者的UID、文件的大小等等。

### 操作系统读写的特点
1.系统在read/write的时候是很耗时的，例如在读文件的时候，将文件内容从硬盘拷贝到内核空间的一个缓冲区，然后再将这些数据拷贝到用户空间，**实际上完成了两次数据拷贝**；  
2.同理，写入操作同样耗时，待写入的buffer在内核空间不能直接访问，必须要先拷贝至内核空间对应的主存，再写回磁盘中（延迟写回），**也是需要两次数据拷贝**；  
3.如果两个进程都对磁盘中的一个文件内容进行访问，那么这个内容在物理内存中有三份：进程A的地址空间 + 进程B的地址空间 + 内核页高速缓冲空间；

此时我们找到了文件读取的痛点：**两次拷贝导致效率过低**

## mmap内存映射
### 映射
“映射”这个词，就和数学课上说的“一一映射”是一个意思，就是建立一种一一对应关系，在这里主要是指**硬盘上文件 的位置与进程逻辑地址空间 中一块大小相同的区域之间的一一对应**。

**注意:这种对应关系纯属是逻辑上的概念，物理上是不存在的，原因是进程的逻辑地址空间本身就是不存在的。**

具体到代码，就是建立并初始化了相关的数据结构（struct address_space），这个过程有系统**调用mmap()实现**，所以建立内存映射的效率很高。

### 查找

1.mmap()会返回一个**指针ptr**，它指向进程逻辑地址空间中的一个地址，这样以后，<u>进程无需再调用read或write对文件进行读写，而只需要通过ptr就能够操作文件</u>。但是ptr所指向的是一个逻辑地址，要操作其中的数据，必须通过MMU将逻辑地址转换成物理地址。
